# ZeroClaw Docker Compose Example
#
# Quick start:
#   1. Copy this file and set your API key
#   2. Run: docker compose up -d
#   3. Access gateway at http://localhost:3000
#
# For more info: https://github.com/zeroclaw-labs/zeroclaw

services:
  zeroclaw:
    build:
      context: .
      target: release
    command: daemon
    # image: ghcr.io/zeroclaw-labs/zeroclaw:latest
    container_name: zeroclaw
    restart: unless-stopped

    environment:
      # Required: Your LLM provider API key
      - API_KEY=${API_KEY:-}
      # Or use the prefixed version:
      # - ZEROCLAW_API_KEY=${ZEROCLAW_API_KEY:-}
      - RUST_LOG=debug,zeroclaw=debug

      # Optional: LLM provider (default: openrouter)
      # Options: openrouter, openai, anthropic, ollama
      - PROVIDER=${PROVIDER:-openrouter}

      # Allow public bind inside Docker (required for container networking)
      - ZEROCLAW_ALLOW_PUBLIC_BIND=true

      # Optional: Model override
      # - ZEROCLAW_MODEL=anthropic/claude-sonnet-4-20250514

      # Telegram Configuration
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_ALLOWED_USERS=${TELEGRAM_ALLOWED_USERS:-}
      # Set to 1 to suppress the "typing..." indicator on Telegram
      - TELEGRAM_SUPPRESS_TYPING=${TELEGRAM_SUPPRESS_TYPING:-0}

      # Discord Configuration
      # - DISCORD_SUPPRESS_TYPING=${DISCORD_SUPPRESS_TYPING:-0}

      # Slack Configuration
      # - SLACK_SUPPRESS_TYPING=${SLACK_SUPPRESS_TYPING:-0}

      # Mattermost Configuration
      # - MATTERMOST_SUPPRESS_TYPING=${MATTERMOST_SUPPRESS_TYPING:-0}

      # Signal Configuration (via signal-cli REST API)
      - SIGNAL_HTTP_URL=${SIGNAL_HTTP_URL:-}
      - SIGNAL_ACCOUNT=${SIGNAL_ACCOUNT:-}
      - SIGNAL_ALLOWED_FROM=${SIGNAL_ALLOWED_FROM:-}

      # Browser Tool Configuration
      # Set ZEROCLAW_BROWSER_ENABLED=1 to allow the agent to browse the web
      - ZEROCLAW_BROWSER_ENABLED=${ZEROCLAW_BROWSER_ENABLED:-1}
      - ZEROCLAW_BROWSER_BACKEND=rust_native
      - ZEROCLAW_BROWSER_NATIVE_WEBDRIVER_URL=http://browser:4444
      # Comma-separated list of allowed domains (empty = all allowed)
      - ZEROCLAW_BROWSER_ALLOWED_DOMAINS=${ZEROCLAW_BROWSER_ALLOWED_DOMAINS:-}

      # HTTP Request Tool Configuration (for APIs and raw HTML scraping)
      # Set ZEROCLAW_HTTP_REQUEST_ENABLED=1 to allow the agent to make HTTP requests
      - ZEROCLAW_HTTP_REQUEST_ENABLED=${ZEROCLAW_HTTP_REQUEST_ENABLED:-1}
      # Comma-separated list of allowed domains, or "*" for all
      - ZEROCLAW_HTTP_REQUEST_ALLOWED_DOMAINS=${ZEROCLAW_HTTP_REQUEST_ALLOWED_DOMAINS:-\*}

    depends_on:
      browser:
        condition: service_healthy

    volumes:
      # Persist workspace and config (must match WORKDIR/HOME in Dockerfile)
      - zeroclaw-data:/zeroclaw-data

    ports:
      # Gateway API port (override HOST_PORT if 3000 is taken)
      - "${HOST_PORT:-3000}:3000"

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

    # Health check â€” uses lightweight status instead of full diagnostics.
    # For images with curl, prefer: curl -f http://localhost:3000/health
    healthcheck:
      test: ["CMD", "zeroclaw", "status"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s

  browser:
    image: selenium/standalone-chromium:latest
    container_name: zeroclaw-browser
    restart: unless-stopped
    shm_size: 2gb
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4444/wd/hub/status"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  zeroclaw-data:
